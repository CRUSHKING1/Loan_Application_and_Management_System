package com.loanapp.loan.service;

import com.loanapp.common.enums.LoanStatus;
import com.loanapp.loan.dto.*;
import com.loanapp.loan.entity.Loan;
import com.loanapp.loan.exception.LoanException;
import com.loanapp.loan.repository.LoanRepository;
import com.loanapp.loan.rule.LoanEligibilityRules;
import com.loanapp.loan.rule.InterestRuleEngine;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class LoanServiceImpl implements LoanService {

    private final LoanRepository loanRepository;
    private final LoanEligibilityRules eligibilityRules;
    private final InterestRuleEngine interestRuleEngine;

    public LoanServiceImpl(LoanRepository loanRepository, LoanEligibilityRules eligibilityRules, InterestRuleEngine interestRuleEngine) {
        this.loanRepository = loanRepository;
        this.eligibilityRules = eligibilityRules;
        this.interestRuleEngine = interestRuleEngine;
    }

    @Override
    public LoanResponseDto applyLoan(Long userId, LoanApplyRequestDto request) {
        // Step 1: Validate eligibility
        eligibilityRules.validateLoanLimits(request.getLoanType(), request.getLoanAmount(), request.getTenureMonths());
        
        // Check user's eligibility (for simplicity assuming dummy values)
        int creditScore = 750;
        double income = 50000;
        int age = 30;

        eligibilityRules.validatePerson(creditScore, income, age);

        // Step 2: Calculate interest rate
        double interestRate = interestRuleEngine.calculate(
                request.getLoanType(), creditScore, income, age, request.getTenureMonths());

        // Step 3: Create loan and save
        Loan loan = new Loan();
        loan.setUserId(userId);
        loan.setLoanType(request.getLoanType());
        loan.setLoanAmount(request.getLoanAmount());
        loan.setTenureMonths(request.getTenureMonths());
        loan.setInterestRate(interestRate);
        loan.setEmiAmount(request.getLoanAmount() * interestRate / 100); // Simplified EMI calculation
        loan.setStatus(LoanStatus.APPLIED);

        loanRepository.save(loan);

        return mapToDto(loan);
    }

    @Override
    public LoanPreviewResponseDto previewLoan(Long userId, LoanApplyRequestDto request) {
        // Check loan eligibility (without saving it to DB)
        int creditScore = 750;
        double income = 50000;
        int age = 30;

        eligibilityRules.validateLoanLimits(request.getLoanType(), request.getLoanAmount(), request.getTenureMonths());
        eligibilityRules.validatePerson(creditScore, income, age);

        // Calculate interest rate based on eligibility
        double interestRate = interestRuleEngine.calculate(request.getLoanType(), creditScore, income, age, request.getTenureMonths());

        // Return the preview information without persisting the loan
        LoanPreviewResponseDto previewDto = new LoanPreviewResponseDto();
        previewDto.setInterestRate(interestRate);
        previewDto.setEmiAmount(request.getLoanAmount() * interestRate / 100);  // Simplified calculation
        previewDto.setTotalPayable(previewDto.getEmiAmount() * request.getTenureMonths());

        return previewDto;
    }

    @Override
    public LoanResponseDto approveOrRejectLoan(Long loanId, LoanApprovalRequestDto request) {
        Loan loan = loanRepository.findById(loanId)
                .orElseThrow(() -> new LoanException("Loan not found"));

        if (request.isApproved()) {
            loan.setStatus(LoanStatus.APPROVED);
        } else {
            loan.setStatus(LoanStatus.REJECTED);
            loan.setRejectionReason(request.getRejectionReason());
          
        }

        loanRepository.save(loan);
        return mapToDto(loan);
    }

    @Override
    public LoanResponseDto activateLoan(Long loanId) {
        Loan loan = loanRepository.findById(loanId)
                .orElseThrow(() -> new LoanException("Loan not found"));
        loan.setStatus(LoanStatus.ACTIVE);
        loanRepository.save(loan);
        return mapToDto(loan);
    }

    @Override
    public LoanResponseDto closeLoan(Long loanId) {
        Loan loan = loanRepository.findById(loanId)
                .orElseThrow(() -> new LoanException("Loan not found"));
        loan.setStatus(LoanStatus.CLOSED);
        loanRepository.save(loan);
        return mapToDto(loan);
    }

    @Override
    public List<LoanResponseDto> getLoansByUser(Long userId) {
        return loanRepository.findByUserId(userId).stream()
                .map(this::mapToDto).toList();
    }

    @Override
    public List<LoanResponseDto> getLoansByUserAndStatus(Long userId, LoanStatus status) {
        return loanRepository.findByUserIdAndStatus(userId, status).stream()
                .map(this::mapToDto).toList();
    }

    @Override
    public List<LoanResponseDto> getAllLoans() {
        return loanRepository.findAll().stream()
                .map(this::mapToDto).toList();
    }

    @Override
    public List<LoanResponseDto> getLoansByStatus(LoanStatus status) {
        return loanRepository.findByStatus(status).stream()
                .map(this::mapToDto).toList();
    }

    private LoanResponseDto mapToDto(Loan loan) {
        LoanResponseDto dto = new LoanResponseDto();
        dto.setLoanId(loan.getId());
        dto.setLoanType(loan.getLoanType());
        dto.setLoanAmount(loan.getLoanAmount());
        dto.setTenureMonths(loan.getTenureMonths());
        dto.setInterestRate(loan.getInterestRate());
        dto.setEmiAmount(loan.getEmiAmount());
        dto.setStatus(loan.getStatus());
        dto.setRejectionReason(loan.getRejectionReason());
        return dto;
    }
}
