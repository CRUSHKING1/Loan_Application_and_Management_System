package com.loanapp.kyc.service;

import com.loanapp.common.enums.KycStatus;
import com.loanapp.kyc.dto.KycRequestDto;
import com.loanapp.kyc.dto.KycResponseDto;
import com.loanapp.kyc.entity.Kyc;
import com.loanapp.kyc.repository.KycRepository;
import com.loanapp.kyc.service.KycService;

import java.util.List;

import org.springframework.stereotype.Service;

@Service
public class KycServiceImpl implements KycService {

    private final KycRepository kycRepository;

    public KycServiceImpl(KycRepository kycRepository) {
        this.kycRepository = kycRepository;
    }

    @Override
    public KycResponseDto submitKyc(Long userId, KycRequestDto dto) {

        Kyc kyc = new Kyc();
        kyc.setUserId(userId);
        kyc.setFullName(dto.getFullName());
        kyc.setPanNumber(dto.getPanNumber());
        kyc.setAadhaarLast4(dto.getAadhaarLast4());
        kyc.setStatus(KycStatus.PENDING);

        return mapToDto(kycRepository.save(kyc));
    }

    @Override
    public KycResponseDto approveKyc(Long userId) {//admin
        Kyc kyc = kycRepository.findByUserId(userId)
                .orElseThrow(() -> new RuntimeException("KYC not found"));

        kyc.setStatus(KycStatus.APPROVED);
        return mapToDto(kycRepository.save(kyc));
    }

    @Override
    public KycResponseDto rejectKyc(Long userId) {//admin
        Kyc kyc = kycRepository.findByUserId(userId)
                .orElseThrow(() -> new RuntimeException("KYC not found"));

        kyc.setStatus(KycStatus.REJECTED);
        return mapToDto(kycRepository.save(kyc));
    }

    @Override
    public boolean isKycApproved(Long userId) {
        return kycRepository.findByUserId(userId)
                .map(k -> k.getStatus() == KycStatus.APPROVED)
                .orElse(false);
    }
   
    
    @Override
    public List<KycResponseDto> getPendingKycs() {
        return kycRepository.findByStatus(KycStatus.PENDING)
                .stream()
                .map(this::mapToDto)
                .toList();
    }

    @Override
    public KycResponseDto getKycByUserId(Long userId) {
        Kyc kyc = kycRepository.findByUserId(userId)
                .orElseThrow(() -> new RuntimeException("KYC not found"));
        return mapToDto(kyc);
    }
    private KycResponseDto mapToDto(Kyc kyc) {
        KycResponseDto dto = new KycResponseDto();
        dto.setUserId(kyc.getUserId());
        dto.setFullName(kyc.getFullName());
        dto.setPanNumber(kyc.getPanNumber());
        dto.setAadhaarLast4(kyc.getAadhaarLast4());
        dto.setStatus(kyc.getStatus());
        return dto;
    }
}